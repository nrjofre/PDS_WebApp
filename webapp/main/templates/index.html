{% extends 'base.html' %}
{% block content %}

    <h1>Home Page</h1>
    <div id="konva-holder">
        
    </div>
    <script>
        const canvasHeight = 600;
        const canvasWidth = 700;
        const barShape = 20;
        const barThickness = barShape/2;
        let transformers = [];

        let stage = new Konva.Stage({
            height: canvasHeight,
            width: canvasWidth,
            container: "konva-holder",
        });
        stage.getContainer().style.border = '1px solid black';
        let layer = new Konva.Layer();
        stage.add(layer);

        // let rect = new Konva.Rect({
        //     stroke: "black",
        //     width: canvasWidth,
        //     height: canvasHeight,
        // });
        // layer.add(rect);
        // layer.draw();

        let bar = null;
        let isDrawing = false;

        stage.on("dblclick", doubleclickHandler);
        stage.on("click", (e) => {
            if (e.target.attrs.name === "bar"){
                console.log("bar clicked.");
                tr = new Konva.Transformer({
                    name: "Transformer",
                    anchorStroke: 'red',
                    anchorFill: 'lightblue',
                    anchorSize: 5,
                    borderStroke: 'green',
                    borderDash: [2, 2],
                    nodes: [e.target],
                });
                layer.add(tr);
                transformers.push(tr);
            }
            else {
                transformers.forEach(function (t){
                t.destroy();
            })
            }
        });
        // stage.on("mousemove", mousemoveHandler);
        // stage.on("mouseup", mouseupHandler);

        let clickPositionX = null;
        let clickPositionY = null;
        function doubleclickHandler(){
            isDrawing = true;
            bar = new Konva.Rect({
                name: "bar",
                x: stage.getPointerPosition().x - barThickness,
                y: stage.getPointerPosition().y - barThickness,
                width: barShape,
                height: barShape,
                fill: "lightblue",
                stroke: "black",
                draggable: true,
            });
            
            // bar.on("click", barClickHandler);
            layer.add(bar).batchDraw();
        }

        function mouseupHandler(){
            isDrawing = false;
        }


        function mousemoveHandler(){
            if (!isDrawing) return false;
            const newWidth = stage.getPointerPosition().x - bar.x() + barThickness;
            const newHeight = stage.getPointerPosition().y - bar.y() + barThickness;
            bar.width(newWidth).height(newHeight);
            layer.batchDraw();    
        }

        

    </script>

{% endblock %}